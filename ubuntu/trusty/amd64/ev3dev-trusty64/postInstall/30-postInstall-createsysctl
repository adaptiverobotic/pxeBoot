#!/bin/bash
# -----------------------------------------------------------------------------
# 30-postInstall-createsysctl
#
# This is one of a series of scripts that live in /root/postInstall. They are
# placed there to avoid being read by casual users and are intended to be
# executed immediately after the VM is created to set up host specific
# configuration.
#
# Checks to see if there's a backup for /etc/sysctl.conf - if not then it
# backs up the original sysctl.conf and adds a stanza that disables IPV6
# -----------------------------------------------------------------------------

. /root/postInstall/postInstall-setupvars

# -----------------------------------------------------------------------------
# Check if there's already a backup - return immediately if there is

if [[ -e "${postInstallBackupDir}/etc/sysctl.conf" ]]; then
    echo "Backup of /etc/sysctl.conf already exists - exiting"
    return
fi

if [[ -e "/etc/sysctl.conf" ]]; then
    cp --parents "/etc/sysctl.conf" "${postInstallBackupDir}"
fi

echo "Disable IPV6 by updating /etc/sysctl.conf"

cat <<END-OF_FILE >> "/etc/sysctl.conf"
# Autogenerated by /root/postInstall/10-postInstall-createsysctl - if you need
# to add more entries, consider updating the script!
#
#disable ipv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
END-OF_FILE

# -----------------------------------------------------------------------------
