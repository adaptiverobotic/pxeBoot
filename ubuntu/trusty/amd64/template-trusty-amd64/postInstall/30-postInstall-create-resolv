#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# 30-postInstall-create-resolv
#
# This is one of a series of scripts that live in /root/postInstall. They are
# placed there to avoid being read by casual users and are intended to be
# executed immediately after the VM is created to set up host specific 
# configuration.
#
# Checks to see if there's a backup for /etc/resolv.conf - if not then it
# backs up the original resolv.conf if it exists and writes out a new one
#
# Copyright (C) 2014-2015 Ralph Hempel <rhempel@hempeldesigngroup.com>
#
# See LICENSE for https://github.com/rhempel/pxeBoot
# -----------------------------------------------------------------------------

. /root/postInstall/postInstall-setupvars

# -----------------------------------------------------------------------------
# Check if there's already a backup

FILE="/etc/resolv.conf"
BACKUP="${postInstallBackupDir}${FILE}"

if [[ -e "${FILE}" ]] && [[ ! -e "${BACKUP}" ]]; then
    echo "Backing up \"${FILE}\""
    cp --parents "${FILE}" "${postInstallBackupDir}"    
fi

# -----------------------------------------------------------------------------

echo "Create new \"${FILE}\""

cat <<END-OF-FILE > "${FILE}"
# -----------------------------------------------------------------------------
# Autogenerated by $0
#
# If you need to change things, consider updating the script or adding
# a custom script to your VM postInstall folder.
#
# It's likely to get overwritten - this is just for the first reboot
#
nameserver ${ipv4DNSA}
nameserver ${ipv4DNSB}

nameserver ${ipv6DNSA}
nameserver ${ipv6DNSB}
END-OF-FILE

# -----------------------------------------------------------------------------
